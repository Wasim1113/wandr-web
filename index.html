<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wandr ‚Äî Plan your trip</title>
  <style>
    *{box-sizing:border-box} :root{--brand:#0ea5e9}
    body{margin:0;background:#0b0b0c;color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:960px;margin:0 auto;padding:1rem}
    .card{background:#0f1115;border:1px solid #1f2937;border-radius:16px;padding:1.25rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border-radius:9999px;padding:.7rem 1rem;font-weight:600;border:1px solid transparent;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:transparent;border-color:#374151;color:#e5e7eb}
    .btn-outline:hover{background:#111827}
    .input{width:100%;border-radius:12px;border:1px solid #374151;padding:.8rem 1rem;font-size:1rem;background:#0b0b0c;color:#e5e7eb}
    .input:focus{outline:2px solid var(--brand);outline-offset:1px}
    .badge{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #374151;padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
    hr.sep{border:0;border-top:1px dashed #374151;margin:.75rem 0}
    .meta{font-size:.8rem;color:#9ca3af;margin-top:.25rem}
    .hide{display:none}
    /* Typeahead */
    .ta-wrap{position:relative}
    .ta-list{position:absolute;z-index:20;left:0;right:0;top:calc(100% + 6px);background:#0b0b0c;border:1px solid #374151;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.35);max-height:280px;overflow:auto}
    .ta-item{padding:.6rem .85rem;cursor:pointer}
    .ta-item:hover,.ta-item.active{background:#111827}
    .ta-empty{padding:.6rem .85rem;color:#9ca3af}
    /* Chat */
    .chatShell{display:flex;flex-direction:column;min-height:100dvh}
    .chatBody{flex:1;overflow:auto;padding:1rem}
    .bubble{max-width:72ch;padding:.75rem 1rem;border-radius:18px;line-height:1.45}
    .user{background:#1d4ed8;color:#eef2ff;border-bottom-right-radius:6px}
    .assistant{background:#0f172a;color:#e5e7eb;border-bottom-left-radius:6px}
    .toolbar{position:sticky;bottom:0;background:linear-gradient(to top,rgba(0,0,0,.9),rgba(0,0,0,.75),transparent);padding:.75rem;backdrop-filter:blur(6px)}
    .inputRow{display:flex;gap:.5rem}.inputRow .grow{flex:1}
    @media (max-width:560px){.card{border-radius:12px}h1{font-size:1.6rem}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
  <!-- Landing -->
  <main id="landing" class="container" style="display:grid;place-items:center;min-height:100dvh">
    <div class="card" style="width:100%;max-width:720px">
      <div class="badge">üß≠ Wandr Trip Agent</div>
      <h1 style="font-weight:800;margin:.5rem 0 0">Where's your next adventure?</h1>
      <p style="opacity:.85;margin:.25rem 0 1rem">Start typing a city and pick a result. We‚Äôll plan it together in chat.</p>

      <form id="landingForm" style="display:grid;gap:.6rem;margin-top:.25rem">
        <div class="ta-wrap">
          <input id="destination" class="input" placeholder="e.g., Tokyo, Japan" aria-label="Destination" autocomplete="off" />
          <div id="taList" class="ta-list hide" role="listbox" aria-label="City suggestions"></div>
        </div>
        <button id="startBtn" class="btn btn-primary" type="submit">Start Planning ‚Üí</button>
        <div id="err" class="meta" style="color:#fca5a5;display:none"></div>
      </form>

      <hr class="sep" />
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <span class="badge">‚ú® Seamless chat onboarding</span>
        <span class="badge">üó∫Ô∏è Smart itinerary drafts</span>
        <span class="badge">üìÑ One-click PDF export</span>
        <span class="badge">üåô Dark mode ready</span>
      </div>
    </div>
  </main>

  <!-- Chat -->
  <main id="chat" class="chatShell hide">
    <div class="container" style="padding-top:1rem;padding-bottom:.25rem">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:1rem">
        <div style="display:flex;align-items:center;gap:.5rem">
          <span style="font-size:1.25rem">üß≠</span>
          <div>
            <div style="font-weight:800">Wandr Trip Agent</div>
            <div id="destLabel" class="meta">Destination: ‚Äî</div>
          </div>
        </div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button id="pdfBtn" class="btn btn-outline hide" type="button">Export PDF</button>
        </div>
      </div>
    </div>

    <div id="chatBody" class="chatBody">
      <div class="container" id="msgs" style="display:grid;gap:.75rem"></div>
    </div>

    <div class="toolbar">
      <div class="container inputRow">
        <input id="draft" class="input grow" placeholder="Answer here‚Ä¶ (e.g., 5 days, mid-range budget)" aria-label="Message"/>
        <button id="sendBtn" class="btn btn-primary" type="button">Send</button>
      </div>
      <div class="container" style="margin-top:.35rem">
        <span class="meta">Tip: Paste bullets like ‚Äúvegan, museums, sunset views‚Äù ‚Äî I‚Äôll parse them.</span>
      </div>
    </div>
  </main>

  <script>
    /* ========================
       CONFIG + GLOBAL STATE
       ======================== */
    const BACKEND = "https://wandr-worker.wasim1113.workers.dev/api/agent";
    window.BACKEND = BACKEND; // for console tests
    const $ = (id) => document.getElementById(id);

    let messages = [];
    let memory = {};
    let itinerary = null;
    let busy = false;

    // DOM refs
    let landing, chat, destInput, destLabel, taList, msgs, draft, sendBtn, chatBody, pdfBtn, err, startBtn;

    /* ========================
       UI HELPERS
       ======================== */
    function appendMsg(role, content) {
      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.justifyContent = role === "user" ? "flex-end" : "flex-start";
      const b = document.createElement("div");
      b.className = "bubble " + (role === "user" ? "user" : "assistant");
      b.textContent = content;
      wrap.appendChild(b);
      msgs.appendChild(wrap);
      chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
    }

    function setBusy(on) {
      busy = on;
      if (sendBtn) sendBtn.disabled = on;
      if (startBtn) startBtn.disabled = on;
      if (on) {
        const thinking = document.createElement("div");
        thinking.id = "_thinking";
        thinking.className = "assistant bubble";
        thinking.style.opacity = ".75";
        thinking.textContent = "Thinking‚Ä¶";
        msgs.appendChild(thinking);
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
      } else {
        const t = document.getElementById("_thinking");
        if (t) t.remove();
      }
    }

    function showError(text) {
      if (!err) return;
      err.textContent = text;
      err.style.display = "block";
      setTimeout(() => (err.style.display = "none"), 4500);
    }

    /* ========================
       BACKEND CALL
       ======================== */
    async function agentCall(payload) {
      const res = await fetch(BACKEND, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Agent error");
      return res.json();
    }

    /* ========================
       CHAT FLOW
       ======================== */
    async function boot(destination) {
      setBusy(true);
      try {
        const data = await agentCall({ messages: [], memory: { destination }, mode: "boot" });
        memory = data.memory || { destination };
        destLabel.textContent = "Destination: " + (memory.destination || "‚Äî");
        const first = data.assistant_message || "Hi! How many days will you be staying?";
        appendMsg("assistant", first);
        messages.push({ role: "assistant", content: first });
        if (data.itinerary) { itinerary = data.itinerary; pdfBtn.classList.remove("hide"); }
      } catch (e) {
        console.error(e);
        appendMsg("assistant", "Sorry ‚Äî I hit an error starting the chat. Please try again.");
      } finally { setBusy(false); }
    }

    async function sendUser(text) {
      if (!text.trim() || busy) return;
      const userMsg = { role: "user", content: text.trim() };
      messages.push(userMsg);
      appendMsg("user", userMsg.content);
      draft.value = "";
      setBusy(true);
      try {
        const data = await agentCall({ messages, memory, mode: itinerary ? "modify" : "ask", itinerary });
        memory = data.memory || memory;
        if (data.itinerary) { itinerary = data.itinerary; pdfBtn.classList.remove("hide"); }
        const reply = data.assistant_message || "Okay!";
        messages.push({ role: "assistant", content: reply });
        appendMsg("assistant", reply);
      } catch (e) {
        console.error(e);
        appendMsg("assistant", "Sorry ‚Äî I hit an error. Try again in a moment.");
      } finally { setBusy(false); }
    }

    async function exportPDF() {
      if (!itinerary) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt" });
      const L = 56; let y = 64; const W = 528;

      doc.setFontSize(18); doc.text(`Wandr Itinerary ‚Äî ${(memory.destination||"Trip")}`, L, y); y += 18;
      doc.setFontSize(11); doc.text(new Date().toLocaleString(), L, y); y += 24;

      function addLine(txt, gap=16) {
        const lines = doc.splitTextToSize(txt, W);
        lines.forEach(line => { doc.text(line, L, y); y += 14; });
        y += (gap - 14);
        if (y > 760) { doc.addPage(); y = 64; }
      }

      if (itinerary.summary) { doc.setFontSize(13); addLine(itinerary.summary, 22); doc.setFontSize(11); }
      if (Array.isArray(itinerary.days)) {
        itinerary.days.forEach((day, i) => {
          doc.setFontSize(13); addLine(`Day ${i+1}${day.title? " ‚Äî " + day.title : ""}`, 10);
          doc.setFontSize(11);
          if (Array.isArray(day.blocks)) {
            day.blocks.forEach(b => addLine(`‚Ä¢ ${b.time ? "["+b.time+"] " : ""}${b.name}${b.notes? " ‚Äî " + b.notes : ""}`));
          }
          if (day.tips) addLine(`Tips: ${day.tips}`);
          addLine("", 14);
        });
      }
      if (Array.isArray(itinerary.tips)) { doc.setFontSize(13); addLine("General Tips", 10); doc.setFontSize(11); itinerary.tips.forEach(t => addLine("‚Ä¢ " + t)); }
      doc.save(`wandr-itinerary-${Date.now()}.pdf`);
    }

    /* ========================
       TYPEAHEAD (Teleport)
       ======================== */
    let taIdx = -1, taData = [], taTimer;
    function clearTA(){ taList.innerHTML = ""; taList.classList.add("hide"); taIdx = -1; taData = []; }

    async function fetchCities(q){
      try{
        const url = `https://api.teleport.org/api/cities/?search=${encodeURIComponent(q)}&limit=8`;
        const r = await fetch(url);
        if (!r.ok) return [];
        const j = await r.json();
        const items = (j._embedded && j._embedded["city:search-results"]) || [];
        return items.map(x => x.matching_full_name).filter(Boolean);
      }catch(e){ console.error("Typeahead error:", e); return []; }
    }

    function renderTA(items){
      taList.innerHTML = "";
      if (!items.length){ taList.innerHTML = `<div class="ta-empty">No matches</div>`; taList.classList.remove("hide"); return; }
      items.forEach((name,i) => {
        const div = document.createElement("div");
        div.className = "ta-item" + (i===taIdx ? " active" : "");
        div.textContent = name;
        div.setAttribute("role","option");
        div.addEventListener("mousedown", e => { e.preventDefault(); selectTA(i); });
        taList.appendChild(div);
      });
      taList.classList.remove("hide");
    }

    function selectTA(i){
      const sel = taData[i];
      if (!sel) return;
      destInput.value = sel;
      clearTA();
    }

    /* ========================
       INIT / EVENT BINDING
       Robust: bind immediately if DOM is ready,
       otherwise wait for DOMContentLoaded.
       ======================== */
    function init(){
      // cache DOM
      landing = $("landing"); chat = $("chat"); destInput = $("destination"); destLabel = $("destLabel");
      taList = $("taList"); msgs = $("msgs"); draft = $("draft"); sendBtn = $("sendBtn");
      chatBody = $("chatBody"); pdfBtn = $("pdfBtn"); err = $("err"); startBtn = $("startBtn");

      // Logs so you can confirm in console
      console.log("Wandr init v0819.2 ‚Äî handlers bound");

      // Form submit -> start planning
      const form = $("landingForm");
      if (form) form.addEventListener("submit", (e) => {
        e.preventDefault();
        const dest = destInput.value.trim();
        if (!dest){ showError("Please choose a destination"); destInput.focus(); return; }
        landing.classList.add("hide");
        chat.classList.remove("hide");
        memory = { destination: dest };
        destLabel.textContent = "Destination: " + dest;
        // ensure first assistant message container exists
        if (!msgs) msgs = $("msgs");
        if (!chatBody) chatBody = $("chatBody");
        boot(dest);
      });

      // Chat send
      if (sendBtn) sendBtn.addEventListener("click", () => sendUser(draft.value));
      if (draft) draft.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendUser(draft.value); }
      });
      if (pdfBtn) pdfBtn.addEventListener("click", exportPDF);

      // Typeahead wiring
      if (destInput){
        destInput.addEventListener("input", () => {
          const q = destInput.value.trim();
          clearTimeout(taTimer);
          if (q.length < 2){ clearTA(); return; }
          taTimer = setTimeout(async () => {
            taData = await fetchCities(q);
            renderTA(taData);
          }, 220);
        });
        destInput.addEventListener("keydown", (e) => {
          if (taList.classList.contains("hide")) return;
          const max = taData.length - 1;
          if (e.key === "ArrowDown"){ e.preventDefault(); taIdx = Math.min(max, taIdx+1); renderTA(taData); }
          else if (e.key === "ArrowUp"){ e.preventDefault(); taIdx = Math.max(0, taIdx-1); renderTA(taData); }
          else if (e.key === "Enter"){ if (taIdx >= 0){ e.preventDefault(); selectTA(taIdx);} }
          else if (e.key === "Escape"){ clearTA(); }
        });
        document.addEventListener("click", (e)=>{ if (!e.target.closest(".ta-wrap")) clearTA(); });
      }
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init, { once:true });
    } else {
      init();
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wandr — AI Travel Copilot</title>

<!-- Minimal deps for markdown + PDF -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  /* ====== Base / Tokens ====== */
  :root{
    --indigo:#4f46e5; --indigo-50:#eef2ff; --indigo-200:#c7d2fe;
    --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#f9fafb; --card:#ffffff;
    --radius:14px; --radius-lg:20px;
    --shadow:0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
       color:var(--ink); background:var(--bg);}

  /* ====== Layout ====== */
  header{padding:28px 20px; text-align:center}
  main{max-width:1100px; margin:0 auto; padding:0 16px 48px}
  .hidden{display:none !important}

  /* ====== Landing ====== */
  .hero{
    display:flex; align-items:center; justify-content:center;
    min-height:calc(100vh - 160px); text-align:center;
    background: radial-gradient(1200px 600px at 50% -200px, var(--indigo-50), transparent);
    padding:24px;
  }
  .hero-card{
    width:100%; max-width:720px; background:var(--card); border:1px solid var(--line);
    border-radius:var(--radius-lg); padding:28px; box-shadow:var(--shadow);
  }
  .logo{font-weight:800; font-size:28px; letter-spacing:.4px}
  .sub{color:var(--muted); margin:6px 0 20px}

  .search{
    display:flex; gap:10px; flex-direction:column;
  }
  .search input[type="text"]{
    width:100%; padding:16px 18px; border:1px solid var(--line); border-radius:999px;
    font-size:16px; outline:none;
  }
  .row{display:flex; gap:10px}
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--ink);
    border-radius:999px; padding:12px 18px; cursor:pointer; font-weight:600;
  }
  .btn.primary{ background:var(--indigo); color:#fff; border-color:var(--indigo) }
  .link{ color:var(--indigo); background:none; border:none; padding:0; cursor:pointer }

  /* ====== Top App Bar (chat/detail) ====== */
  .appbar{
    position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line);
    padding:10px 12px; display:flex; gap:8px; align-items:center; justify-content:space-between;
  }
  .title{font-weight:700}
  .kebab{width:40px; height:40px; border-radius:999px; border:1px solid var(--line); background:#fff; cursor:pointer}

  /* ====== Chat ====== */
  .chips{display:flex; gap:8px; overflow:auto; padding:8px 0}
  .chip{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:999px; white-space:nowrap; cursor:pointer; font-size:14px}
  .chat{border:1px solid var(--line); background:#fafafa; border-radius:var(--radius); padding:12px; height:46vh; overflow:auto}
  .msg{margin:10px 0; white-space:pre-wrap}
  .msg.user{ text-align:right }
  .composer{display:flex; gap:8px; margin-top:10px}
  .composer input{flex:1; padding:14px 16px; border:1px solid var(--line); border-radius:999px; outline:none}
  .composer .btn{padding:12px 18px}

  .error{display:none; border:1px solid #fecaca; background:#fff1f2; color:#991b1b; border-radius:var(--radius);
    padding:8px 10px; margin:10px 0;}

  /* ====== Detail / Plan ====== */
  .toolbar{display:flex; gap:8px; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(249,250,251,0), #f9fafb 30%); padding-top:8px}
  .plan-grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px }
  .card{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
  .card h3{ margin:0 0 6px; font-size:1rem }
  .badge{ display:inline-block; font-size:.72rem; border:1px solid var(--line); padding:2px 8px; border-radius:999px; margin-right:6px; color:#374151 }
  .section{ margin:8px 0 } .section strong{ display:block; margin-bottom:4px }

  /* ====== Responsive (Desktop) ====== */
  @media (min-width: 900px){
    .search{ flex-direction:row }
    .split{ display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; align-items:start; }
    .chat{ height:60vh }
    .toolbar{ position:static; background:none }
    .plan-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }

  /* ====== Dialogs ====== */
  dialog{ border:1px solid var(--line); border-radius:var(--radius-lg); max-width:540px; width:calc(100% - 32px) }
  dialog::backdrop{ background:rgba(0,0,0,.35) }
  .dialog-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
  .stack{ display:grid; gap:10px }
  .stack input, .stack select{ padding:12px 14px; border:1px solid var(--line); border-radius:10px; outline:none; }
</style>
</head>
<body>

<!-- ====== Landing ====== -->
<header id="landingHeader">
  <div class="logo">Wandr</div>
  <div class="sub">Your AI travel copilot — just tell me where to go.</div>
</header>

<section id="landing" class="hero">
  <div class="hero-card" role="region" aria-label="Start planning">
    <div class="search">
      <input id="landingDestination" type="text" placeholder="Where are you going?" />
      <div class="row">
        <button id="openAdvanced" class="btn" type="button">Advanced options</button>
        <button id="ctaPlan" class="btn primary" type="button">Plan my trip</button>
      </div>
    </div>
  </div>
</section>

<!-- ====== App (Chat + Detail) ====== -->
<section id="app" class="hidden">
  <div class="appbar">
    <button id="backToLanding" class="btn" type="button">←</button>
    <div class="title" id="appTitle">Trip</div>
    <button class="kebab" id="menuBtn" title="Menu">⋮</button>
  </div>

  <main class="split">
    <!-- Left: Chat -->
    <section aria-label="Chat builder">
      <div class="chips" id="chips">
        <button class="chip" data-msg="Format the itinerary as Markdown with headings (## Day 1, ## Day 2) and Morning/Afternoon/Evening/Night sections, with $/$$/$$$/$$$$ tags.">Format as day cards</button>
        <button class="chip" data-msg="More food, fewer museums.">More food, less museums</button>
        <button class="chip" data-msg="Shorter walking distances.">Shorter walks</button>
        <button class="chip" data-msg="Luxury dining only ($$$$).">Luxury only</button>
      </div>

      <div id="error" class="error"></div>
      <div id="chat" class="chat" aria-live="polite" aria-label="Chat transcript"></div>

      <div class="composer">
        <input id="chatInput" placeholder="Tell Wandr what you want (e.g., 3 days, sushi focus, $$)" />
        <button id="sendBtn" class="btn primary" type="button">Send</button>
      </div>
      <small id="chatStatus" class="sub" style="display:block;margin-top:6px;"></small>
    </section>

    <!-- Right: Plan -->
    <section aria-label="Itinerary detail">
      <div class="toolbar">
        <button id="exportPdf" class="btn primary" type="button">Export PDF</button>
        <button id="exportIcs" class="btn" type="button">Export .ics</button>
        <button id="editTrip" class="btn" type="button">Edit trip</button>
      </div>
      <div id="planGrid" class="plan-grid" aria-live="polite"></div>
    </section>
  </main>
</section>

<!-- ====== Advanced Options Dialog ====== -->
<dialog id="advancedDlg">
  <form method="dialog">
    <h3 style="margin:0 0 8px">Trip options</h3>
    <div class="stack">
      <label>Start date <input id="startDate" type="date" /></label>
      <label>End date <input id="endDate" type="date" /></label>
      <div class="row">
        <label style="flex:1">Day start <input id="startTime" type="time" value="09:00" /></label>
        <label style="flex:1">Day end <input id="endTime" type="time" value="21:00" /></label>
      </div>
      <label>Food restrictions <input id="diet" placeholder="e.g., halal, vegetarian" /></label>
      <div class="row">
        <label style="flex:1">Mobility <input id="mobility" placeholder="e.g., easy walks, wheelchair" /></label>
        <label style="flex:1">Walkability <select id="walkability"><option></option><option>low</option><option>med</option><option>high</option></select></label>
      </div>
      <label>Nightlife <select id="nightlife"><option></option><option>low</option><option>med</option><option>high</option></select></label>
      <label>Budget <select id="budget"><option>$</option><option>$$</option><option>$$$</option><option>$$$$</option></select></label>
    </div>
    <div class="dialog-actions">
      <button class="btn" value="cancel" type="button" id="dlgCancel">Cancel</button>
      <button class="btn primary" value="default" type="submit">Save</button>
    </div>
  </form>
</dialog>

<!-- ====== Blocked Destination Modal ====== -->
<dialog id="blockedDlg">
  <article>
    <h3>Heads up</h3>
    <p>That destination isn’t supported right now for safety/data reasons. Try a different location.</p>
    <div class="dialog-actions">
      <button class="btn primary" onclick="document.getElementById('blockedDlg').close()">OK</button>
    </div>
  </article>
</dialog>

<script>
/* ---------- App State ---------- */
const WORKER = 'https://wandr-worker.wasim1113.workers.dev';
const sessionId = ensureSession();
let trip = loadTrip();
let lastAssistantMarkdown = '';

/* ---------- Landing handlers ---------- */
const landing = document.getElementById('landing');
const landingHeader = document.getElementById('landingHeader');
const app = document.getElementById('app');
const appTitle = document.getElementById('appTitle');

document.getElementById('openAdvanced').onclick = () => {
  fillAdvancedFromTrip(); document.getElementById('advancedDlg').showModal();
};
document.getElementById('dlgCancel').onclick = () => document.getElementById('advancedDlg').close();

document.getElementById('advancedDlg').addEventListener('close', () => {
  // on submit, save values to trip + localStorage
  if (document.getElementById('advancedDlg').returnValue !== 'cancel') {
    trip = currentTripFromAdvanced();
    saveTrip(); // persist
  }
});

document.getElementById('ctaPlan').onclick = () => {
  const dest = document.getElementById('landingDestination').value.trim();
  if (!dest) { alert('Please enter a destination'); return; }
  trip.destination = dest;
  saveTrip();
  appTitle.textContent = dest;
  showApp();
};

/* ---------- App top bar ---------- */
document.getElementById('backToLanding').onclick = () => {
  app.classList.add('hidden'); landing.classList.remove('hidden'); landingHeader.classList.remove('hidden');
};

/* ---------- Chat actions ---------- */
document.getElementById('sendBtn').onclick = send;
document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });
document.getElementById('chips').addEventListener('click', (e)=>{
  const el = e.target.closest('.chip'); if(!el) return;
  document.getElementById('chatInput').value = el.dataset.msg; send();
});

/* ---------- Trip edit ---------- */
document.getElementById('editTrip').onclick = () => { fillAdvancedFromTrip(); document.getElementById('advancedDlg').showModal(); };

/* ---------- Export ---------- */
document.getElementById('exportIcs').onclick = exportIcs;
document.getElementById('exportPdf').onclick = exportPdf;

/* ---------- Helpers ---------- */
function ensureSession(){
  let s = localStorage.getItem('wandr_session');
  if (!s) { s = self.crypto?.randomUUID?.() ? crypto.randomUUID() : String(Date.now())+'-'+Math.random().toString(16).slice(2);
    localStorage.setItem('wandr_session', s); }
  return s;
}
function loadTrip(){
  try { return JSON.parse(localStorage.getItem('wandr_trip')||'{}'); } catch { return {}; }
}
function saveTrip(){ localStorage.setItem('wandr_trip', JSON.stringify(trip)); }

/* Advanced dialog <-> trip */
function fillAdvancedFromTrip(){
  const t = trip || {};
  setVal('startDate', t.startDate||'');
  setVal('endDate', t.endDate||'');
  setVal('startTime', t.startTime||'09:00');
  setVal('endTime', t.endTime||'21:00');
  setVal('diet', t.prefs?.food||'');
  setVal('mobility', t.prefs?.mobility||'');
  setVal('walkability', t.prefs?.walkability||'');
  setVal('nightlife', t.prefs?.nightlife||'');
  setVal('budget', t.prefs?.budget||'$$');
}
function currentTripFromAdvanced(){
  return {
    destination: trip.destination || '',
    startDate: getVal('startDate'),
    endDate: getVal('endDate'),
    startTime: getVal('startTime'),
    endTime: getVal('endTime'),
    prefs: {
      food: getVal('diet'),
      mobility: getVal('mobility'),
      walkability: getVal('walkability'),
      nightlife: getVal('nightlife'),
      budget: getVal('budget')
    }
  };
}
function setVal(id, v){ const el = document.getElementById(id); if(el) el.value = v; }
function getVal(id){ const el = document.getElementById(id); return el ? el.value : ''; }

/* Show app view + hydrate title */
function showApp(){
  landing.classList.add('hidden'); landingHeader.classList.add('hidden'); app.classList.remove('hidden');
  appTitle.textContent = trip.destination || 'Trip';
}

/* Chat append and status */
function append(role, text){
  const el = document.createElement('div'); el.className = 'msg ' + role;
  el.textContent = text; document.getElementById('chat').appendChild(el);
  const c = document.getElementById('chat'); c.scrollTop = c.scrollHeight; return el;
}
function showError(msg){ const e = document.getElementById('error'); e.textContent = msg; e.style.display = 'block';
  setTimeout(()=>{ e.style.display = 'none'; }, 5000); }

/* ---------- Chat send (streams) ---------- */
async function send(){
  const input = document.getElementById('chatInput'); const text = input.value.trim(); if(!text) return;

  // ensure we have a destination
  if(!trip.destination){ showError('Set a destination first.'); return; }

  // gentle formatting nudge for plan clarity
  const userMsg = text + "\n\nPlease format as Markdown with headings like '## Day 1', and subsections 'Morning', 'Afternoon', 'Evening', 'Night'. Include $/$$/$$$/$$$$ tags and short tips.";

  append('user', text);
  input.value = ''; setStatus('Thinking…'); disableSend(true);

  try{
    const resp = await fetch(`${WORKER}/chat`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sessionId, message: userMsg, trip })
    });

    if (resp.status === 403){ document.getElementById('blockedDlg').showModal(); setStatus(''); disableSend(false); return; }
    if (resp.status === 429){ showError('Daily usage cap hit (server). Try later.'); setStatus(''); disableSend(false); return; }
    if (!resp.ok){ const j = await resp.json().catch(()=>({})); showError('Error: ' + (j.error || resp.status)); setStatus(''); disableSend(false); return; }

    const reader = resp.body.getReader(); const decoder = new TextDecoder();
    let buffer = ''; const live = append('assistant',''); let full = '';

    while(true){
      const {value, done} = await reader.read(); if(done) break;
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split('\n\n'); buffer = parts.pop() || '';
      for(const p of parts){
        if(!p || p.startsWith(':')) continue;
        const line = p.replace(/^data:\s*/,''); if(!line || line === '[DONE]') continue;
        try{
          const j = JSON.parse(line); const t = j.choices?.[0]?.delta?.content || '';
          if (t){ live.textContent += t; full += t; }
        }catch{}
      }
      const c = document.getElementById('chat'); c.scrollTop = c.scrollHeight;
    }
    setStatus(''); disableSend(false);
    lastAssistantMarkdown = full;
    renderPlanCards(full); // auto-refresh plan on desktop
  }catch(e){
    showError('Network error.'); setStatus(''); disableSend(false);
  }
}

function setStatus(t){ document.getElementById('chatStatus').textContent = t || ''; }
function disableSend(dis){ const b = document.getElementById('sendBtn'); if(dis) b.setAttribute('disabled','true'); else b.removeAttribute('disabled'); }

/* ---------- Plan rendering ---------- */
function renderPlanCards(markdown){
  const grid = document.getElementById('planGrid'); grid.innerHTML = '';
  if(!markdown || !markdown.trim()){ grid.innerHTML = '<div class="sub">No plan yet. Ask for a plan in Chat.</div>'; return; }

  // Split by Day headings
  const dayBlocks = markdown
    .split(/\n(?=#+\s*Day\s*\d+|Day\s*\d+:)/gi)
    .filter(b => /day\s*\d+/i.test(b));

  if(dayBlocks.length === 0){
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = marked.parse(markdown); grid.appendChild(card); return;
  }

  dayBlocks.forEach(block=>{
    const titleMatch = block.match(/^(?:#+\s*)?Day\s*(\d+)/i);
    const dayNum = titleMatch ? titleMatch[1] : '?';
    const sections = extractSections(block);

    const card = document.createElement('div'); card.className='card';
    const badges = [];
    if (trip.prefs?.budget) badges.push(trip.prefs.budget);
    if (trip.prefs?.food) badges.push(trip.prefs.food);
    if (trip.prefs?.mobility) badges.push(trip.prefs.mobility);

    card.innerHTML = `
      <h3>Day ${dayNum}</h3>
      <div>${badges.map(b=>`<span class="badge">${escapeHtml(b)}</span>`).join(' ')}</div>
      ${['Morning','Afternoon','Evening','Night'].map(name=>{
        const html = sections[name] ? marked.parse(sections[name].join('\n')) : '<p class="sub">—</p>';
        return `<div class="section"><strong>${name}</strong>${html}</div>`;
      }).join('')}
    `;
    grid.appendChild(card);
  });
}

function extractSections(block){
  const lines = block.split('\n');
  const sections = { Morning:[], Afternoon:[], Evening:[], Night:[] };
  let current = null; const headerRe = /^(?:#+\s*)?(Morning|Afternoon|Evening|Night)\b[:\-]?\s*$/i;
  for (const raw of lines){
    const m = raw.match(headerRe);
    if (m){ current = m[1][0].toUpperCase() + m[1].slice(1).toLowerCase(); continue; }
    if (!current) continue; sections[current].push(raw);
  }
  return sections;
}
function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------- Exports ---------- */
function exportIcs(){
  const title = `Wandr Trip — ${trip.destination||''}`;
  const dtStart = (trip.startDate || '').replace(/-/g,'');
  const dtEnd = (trip.endDate || '').replace(/-/g,'');
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Wandr//EN',
    'BEGIN:VEVENT',
    `UID:${sessionId}@wandr`,
    `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,
    `DTSTART;VALUE=DATE:${dtStart}`,
    `DTEND;VALUE=DATE:${dtEnd}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:Generated by Wandr`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  download('wandr-trip.ics', ics, 'text/calendar');
}

function exportPdf(){
  // Build from rendered plan cards
  const cards = Array.from(document.querySelectorAll('#planGrid .card'));
  if(cards.length===0){ alert('No itinerary to export yet.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'letter' });
  const margin = 48; let y = margin;
  const pageH = 792, pageW = 612, width = pageW - margin*2;

  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text(`Wandr — ${trip.destination || 'Your Trip'}`, margin, y); y+=20;
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  doc.text(`${trip.startDate || ''} → ${trip.endDate || ''}  |  ${trip.startTime || '09:00'}–${trip.endTime || '21:00'}  |  Budget: ${trip.prefs?.budget || '$$'}`, margin, y); y+=18;

  cards.forEach((c, idx)=>{
    const title = c.querySelector('h3')?.textContent || `Day ${idx+1}`;
    const blocks = c.querySelectorAll('.section');
    const parts=[title];
    blocks.forEach(b=>{
      const label=b.querySelector('strong')?.textContent||'';
      const text=b.innerText.replace(label,'').trim();
      parts.push(`\n${label}\n${text}`);
    });
    const lines = doc.splitTextToSize(parts.join('\n\n'), width);
    const h = lines.length * 14 + 10;
    if (y + h > pageH - margin) { doc.addPage(); y = margin; }
    doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.text(title, margin, y); y += 16;
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(lines.slice(1), margin, y); y += h - 16;
    if (idx < cards.length - 1) { doc.setDrawColor(220); doc.line(margin, y, pageW - margin, y); y += 10; }
  });

  doc.save(`Wandr_${(trip.destination||'trip').replace(/\s+/g,'_')}.pdf`);
}

function download(name, data, type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([data], {type})); a.download=name; a.click();
  URL.revokeObjectURL(a.href);
}

/* ---------- On load ---------- */
(function init(){
  // If we already had a trip saved, prefill landing input
  if (trip?.destination){
    document.getElementById('landingDestination').value = trip.destination;
  }
})();
</script>
</body>
</html>

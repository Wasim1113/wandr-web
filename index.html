<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wandr — AI Trip Copilot</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root { --pico-primary: #4f46e5; } /* Indigo */
  body { max-width: 920px; margin: 0 auto; padding-bottom: 24px; }
  header { margin-top: 12px; }
  .chat { border: 1px solid #e8e8e8; border-radius: 12px; padding: 12px; height: 52vh; overflow:auto; background:#fafafa }
  .msg { margin: 10px 0; white-space: pre-wrap; line-height: 1.35; }
  .msg.user { text-align:right }
  .row { display:flex; gap:8px; }
  .row > * { flex:1; }
  .chips { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0 0 0; }
  .chip { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; background:#fff; cursor:pointer; font-size:.9rem; }
  .divider { border-top: 1px dashed #ddd; margin: 12px 0; }
  details summary { font-weight: 600; }
  .muted { color:#6b7280; }
</style>
</head>
<body>
<header>
  <h1>Wandr</h1>
  <p class="secondary">Chat with an AI agent to build a time-boxed itinerary. Export to PDF or .ics when ready.</p>
</header>

<main>
  <details open>
    <summary>Trip</summary>
    <div class="grid">
      <input id="dest" placeholder="Destination (e.g., Tokyo, Japan)">
      <input id="start" type="date">
      <input id="end" type="date">
    </div>
    <div class="grid">
      <input id="startTime" type="time" value="09:00" title="Daily start time">
      <input id="endTime" type="time" value="21:00" title="Daily end time">
    </div>
    <div class="grid">
      <input id="diet" placeholder="Food restrictions (e.g., halal, vegetarian)">
      <input id="mobility" placeholder="Mobility (e.g., easy walks, wheelchair)">
    </div>
    <div class="grid">
      <input id="walkability" placeholder="Walkability (low/med/high)">
      <input id="nightlife" placeholder="Nightlife (low/med/high)">
      <select id="budget" title="Overall budget band">
        <option>$</option><option>$$</option><option>$$$</option><option>$$$$</option>
      </select>
    </div>
    <div class="row">
      <button id="saveTrip">Save Trip</button>
      <button id="exportPdf" class="contrast">Export PDF</button>
      <button id="exportIcs" class="secondary">Export .ics</button>
    </div>
    <small class="muted">Tip: adjust start/end times to control mornings and evenings in the plan.</small>
  </details>

  <div class="divider"></div>

  <div class="chips">
    <button class="chip" data-msg="Make mornings shorter and add a late brunch.">Shorter mornings</button>
    <button class="chip" data-msg="More food stops, fewer museums.">More food, less museums</button>
    <button class="chip" data-msg="Raise the budget to $$$ for restaurants only.">Raise restaurant budget to $$$</button>
    <button class="chip" data-msg="Swap tonight's dinner for a casual $$ spot within a 10-minute walk.">Swap dinner only</button>
    <button class="chip" data-msg="Add one scenic photography spot each afternoon.">Add photo spots</button>
  </div>

  <div class="divider"></div>

  <div class="chat" id="chat" aria-live="polite" aria-label="Chat transcript"></div>

  <div class="row" style="margin-top:8px;">
    <input id="input" placeholder="Tell Wandr what you want (e.g., 3 days, sushi focus, $$)">
    <button id="send">Send</button>
  </div>

  <small id="status" class="muted"></small>
</main>

<script>
const WORKER = 'https://wandr-worker.wasim1113.workers.dev';
const sessionId = ensureSession();
let trip = loadTrip();

document.getElementById('saveTrip').onclick = () => {
  trip = currentTripFromUI();
  localStorage.setItem('wandr_trip', JSON.stringify(trip));
  toast('Trip saved.');
};

document.querySelectorAll('.chip').forEach(ch => ch.addEventListener('click', () => {
  document.getElementById('input').value = ch.dataset.msg;
  send();
}));

document.getElementById('send').onclick = send;
document.getElementById('input').addEventListener('keydown', e => { if (e.key==='Enter') send(); });

// ---- UI helpers ----
function id(x){ return document.getElementById(x); }
function val(x){ return id(x).value; }
function toast(t){ id('status').textContent = t; setTimeout(()=>id('status').textContent='', 2200); }
function ensureSession(){
  let s = localStorage.getItem('wandr_session');
  if (!s) { s = self.crypto?.randomUUID?.() ? crypto.randomUUID() : String(Date.now())+'-'+Math.random().toString(16).slice(2); localStorage.setItem('wandr_session', s); }
  return s;
}
function currentTripFromUI(){ 
  return {
    destination: val('dest'),
    startDate: val('start'),
    endDate: val('end'),
    startTime: val('startTime'),
    endTime: val('endTime'),
    prefs: {
      food: val('diet'),
      mobility: val('mobility'),
      walkability: val('walkability'),
      nightlife: val('nightlife'),
      budget: val('budget')
    }
  };
}
function loadTrip(){
  const t = localStorage.getItem('wandr_trip');
  if (!t) return {};
  const tt = JSON.parse(t);
  id('dest').value = tt.destination || '';
  id('start').value = tt.startDate || '';
  id('end').value = tt.endDate || '';
  id('startTime').value = tt.startTime || '09:00';
  id('endTime').value = tt.endTime || '21:00';
  id('diet').value = tt.prefs?.food || '';
  id('mobility').value = tt.prefs?.mobility || '';
  id('walkability').value = tt.prefs?.walkability || '';
  id('nightlife').value = tt.prefs?.nightlife || '';
  id('budget').value = tt.prefs?.budget || '$$';
  return tt;
}

// ---- Chat flow ----
async function send(){
  const text = val('input').trim();
  if (!text) return;

  // capture latest trip state
  trip = currentTripFromUI();

  if (!trip.destination || !trip.startDate || !trip.endDate) {
    toast('Please fill Destination, Start, End dates, then Save Trip.');
    return;
  }

  append('user', text);
  id('input').value = '';
  id('status').textContent = 'Thinking…';

  try {
    const resp = await fetch(`${WORKER}/chat`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ sessionId, message: text, trip })
    });

    if (resp.status === 429) { append('assistant', 'You hit the daily limit. Export or try tomorrow.'); id('status').textContent=''; return; }
    if (resp.status === 403) { append('assistant', 'This destination is not supported for safety/data reasons.'); id('status').textContent=''; return; }
    if (!resp.ok) { 
      const j = await resp.json().catch(()=>({}));
      append('assistant', 'Error: '+(j.error||resp.status));
      id('status').textContent='';
      return;
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    const live = append('assistant', '');

    while (true) {
      const {value, done} = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, {stream:true});
      const parts = buffer.split('\n\n');
      buffer = parts.pop() || '';
      for (const p of parts) {
        if (!p) continue;
        if (p.startsWith(':')) continue; // keep-alive
        const line = p.replace(/^data:\s*/,'');
        if (!line || line === '[DONE]') continue;
        try {
          const json = JSON.parse(line);
          const t = json.choices?.[0]?.delta?.content || '';
          if (t) live.textContent += t;
        } catch { /* ignore partial frames */ }
      }
      // auto-scroll
      const chat = id('chat'); chat.scrollTop = chat.scrollHeight;
    }
    id('status').textContent = '';
  } catch (err) {
    append('assistant', 'Network error. Check Worker URL and try again.');
    id('status').textContent = '';
  }
}

function append(role, text){
  const el = document.createElement('div');
  el.className = `msg ${role}`;
  el.textContent = text;
  id('chat').appendChild(el);
  id('chat').scrollTop = id('chat').scrollHeight;
  return el;
}

// ---- Exports ----
// PDF export using jsPDF (captures last assistant message as the itinerary)
document.getElementById('exportPdf').onclick = () => {
  const lastAssistant = Array.from(document.querySelectorAll('.msg.assistant')).pop();
  const itineraryText = lastAssistant ? lastAssistant.textContent : 'No itinerary yet.';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'letter' }); // 612 x 792 pt
  const margin = 48; let cursor = margin;

  doc.setFont('helvetica', 'bold'); doc.setFontSize(18);
  doc.text(`Wandr — ${trip.destination || 'Your Trip'}`, margin, cursor); cursor += 12;
  doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
  const sub = `${trip.startDate || ''} → ${trip.endDate || ''}  |  ${trip.startTime || '09:00'}–${trip.endTime || '21:00'}  |  Budget: ${trip.prefs?.budget || '$$'}`;
  cursor += 18; doc.text(sub, margin, cursor); cursor += 18;

  const wrap = (text, width) => doc.splitTextToSize(text, width);
  const paragraphs = itineraryText.split(/\n{2,}/);

  paragraphs.forEach((p, i) => {
    const lines = wrap(p, 612 - margin*2);
    const height = lines.length * 14;
    if (cursor + height + 40 > 792 - margin) { doc.addPage(); cursor = margin; }
    doc.text(lines, margin, cursor); cursor += height + 12;
    if (i < paragraphs.length - 1) { doc.setDrawColor(220); doc.line(margin, cursor, 612-margin, cursor); cursor += 12; }
  });

  doc.save(`Wandr_${(trip.destination||'trip').replace(/\s+/g,'_')}.pdf`);
};

// Minimal .ics (whole-trip placeholder). You can later extend to per-event.
document.getElementById('exportIcs').onclick = () => {
  const title = `Wandr Trip — ${trip.destination||''}`;
  const dtStart = (trip.startDate || '').replace(/-/g,'');
  const dtEnd = (trip.endDate || '').replace(/-/g,'');
  const ics = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Wandr//EN',
    'BEGIN:VEVENT',
    `UID:${sessionId}@wandr`,
    `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,
    `DTSTART;VALUE=DATE:${dtStart}`,
    `DTEND;VALUE=DATE:${dtEnd}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:Generated by Wandr`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([ics], {type:'text/calendar'}));
  a.download = 'wandr-trip.ics';
  a.click(); URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
